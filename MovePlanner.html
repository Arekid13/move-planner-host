<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TotallyMoving ‚Äì Move Planner</title>
  <!-- ‚ú® STYLE & LIBRARIES -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Google loader comes last; we initialise once it finishes -->
  <script src="https://www.gstatic.com/charts/loader.js" onload="onGoogleLoaderReady()"></script>
  <style>
    :root {
      /* Updated brand palette */
      --tm-primary: #009fe3;
      --tm-secondary: #6b2dff;
      --tm-light: #f4f8fb;
    }
    body, .bubble-element {
      background: var(--tm-light);
      font-family: "Segoe UI", Arial, sans-serif;
    }
    .tm-btn {
      background: var(--tm-primary);
      border: none;
      color: #fff;
    }
    .tm-btn:hover {
      background: var(--tm-secondary);
    }
    .navbar {
      background: var(--tm-primary);
    }
    .navbar-brand,
    .nav-link,
    .navbar-brand:hover,
    .nav-link:hover {
      color: #fff !important;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    /* make charts responsive */
    .card canvas {
      width: 100% !important;
      height: 300px !important;
    }
  </style>
</head>
<body>
  <!-- üåê NAVIGATION -->
  <nav class="navbar navbar-expand-lg navbar-dark px-3 mb-4">
    <a class="navbar-brand fw-bold" href="#">Move Planner</a>
  </nav>

  <div class="container-fluid mb-5" id="app-container">
    <!-- USER DETAILS -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Your Move Details</h5>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Full Name</label>
          <input type="text" id="user-name" class="form-control" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Email Address</label>
          <input type="email" id="user-email" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Planned Move Date</label>
          <input type="date" id="move-date" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Old Address</label>
          <input type="text" id="old-address" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">New Address</label>
          <input type="text" id="new-address" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Budget for Move (¬£)</label>
          <input type="number" id="move-budget" class="form-control" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Purchase Price (¬£)</label>
          <input type="number" id="purchase-price" class="form-control" />
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn tm-btn w-100" onclick="saveData()">üíæ Save Plan</button>
        </div>
      </div>
    </div>

    <!-- PROGRESS & REMINDERS SUMMARY -->
    <div class="card mb-4">
      <div class="card-body d-flex flex-column flex-md-row align-items-center gap-4">
        <div class="w-100">
          <h6>Overall Progress</h6>
          <div class="progress" role="progressbar">
            <div class="progress-bar bg-success" id="progress-bar" style="width: 0%">0%</div>
          </div>
        </div>
        <button class="btn tm-btn" onclick="exportPDF()">üìÑ Export to PDF</button>
        <button class="btn btn-outline-secondary" onclick="scheduleReminders()">‚è∞ Enable Reminders</button>
      </div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-3" id="tmTab" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tasks">Tasks</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#budget">Budget</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gantt">Gantt</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#contacts">Contacts</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#files">Files</button></li>
    </ul>

    <div class="tab-content" id="tmTabContent">
      <!-- TASKS TAB -->
      <div class="tab-pane fade show active" id="tasks">
        <div class="card p-3">
          <!-- Add Task UI -->
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-3">
              <select id="new-task-section" class="form-select"></select>
            </div>
            <div class="col-12 col-md-7">
              <input type="text" id="new-task-text" class="form-control" placeholder="New task description" />
            </div>
            <div class="col-12 col-md-2">
              <button class="btn tm-btn w-100" onclick="addTask()">Add Task</button>
            </div>
          </div>
          <div class="accordion" id="taskAccordion"></div>
        </div>
      </div>

      <!-- BUDGET TAB -->
      <div class="tab-pane fade" id="budget">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card p-3 h-100">
              <h6>Add Expense</h6>
              <div class="row g-2 align-items-end">
                <div class="col-6"><input type="text" id="expense-name" class="form-control" placeholder="Category" /></div>
                <div class="col-4"><input type="number" id="expense-amount" class="form-control" placeholder="Amount" /></div>
                <div class="col-2"><button class="btn tm-btn w-100" onclick="addExpense()">+</button></div>
              </div>
              <ul class="list-group mt-3" id="expense-list"></ul>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card p-3 mb-3"><canvas id="pieChart"></canvas></div>
            <div class="card p-3"><canvas id="lineChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- GANTT TAB -->
      <div class="tab-pane fade" id="gantt">
        <div class="card p-3">
          <div id="ganttChart" style="height: 400px; min-height: 300px;"></div>
          <button class="btn btn-sm tm-btn mt-2" onclick="drawGantt()">üîÑ Refresh Gantt</button>
        </div>
      </div>

      <!-- CONTACTS TAB -->
      <div class="tab-pane fade" id="contacts">
        <div class="card p-3">
          <div class="row g-2 align-items-end mb-3">
            <div class="col-md-3"><input class="form-control" id="contact-role" placeholder="Role" /></div>
            <div class="col-md-3"><input class="form-control" id="contact-name" placeholder="Name" /></div>
            <div class="col-md-3"><input class="form-control" id="contact-phone" placeholder="Phone" /></div>
            <div class="col-md-3"><input class="form-control" id="contact-email" placeholder="Email" /></div>
            <div class="col-12 mt-2"><button class="btn tm-btn" onclick="addContact()">Add Contact</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead><tr><th>Role</th><th>Name</th><th>Phone</th><th>Email</th><th></th></tr></thead>
              <tbody id="contacts-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- FILES TAB -->
      <div class="tab-pane fade" id="files">
        <div class="card p-3">
          <div class="mb-3"><label class="form-label">Upload Files (PDF, images, etc.)</label><input class="form-control" type="file" id="file-input" multiple /></div>
          <ul class="list-group" id="file-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- üîß SCRIPT LOGIC -->
  <script>
    const g = (id) => document.getElementById(id);

    /* ================= LOCAL STORAGE ================= */
    function saveData() {
      const data = {
        name: g("user-name").value,
        email: g("user-email").value,
        moveDate: g("move-date").value,
        oldAddr: g("old-address").value,
        newAddr: g("new-address").value,
        budget: g("move-budget").value,
        purchase: g("purchase-price").value,
        tasks,
        expenses,
        contacts,
      };
      localStorage.setItem("tm_movePlan", JSON.stringify(data));
      alert("‚úÖ Plan saved locally!");
    }
    function loadData() {
      const raw = localStorage.getItem("tm_movePlan");
      if (!raw) return;
      const d = JSON.parse(raw);
      [
        ["user-name", "name"],
        ["user-email", "email"],
        ["move-date", "moveDate"],
        ["old-address", "oldAddr"],
        ["new-address", "newAddr"],
        ["move-budget", "budget"],
        ["purchase-price", "purchase"],
      ].forEach(([id, key]) => (g(id).value = d[key] || ""));
      if (d.tasks) { tasks = d.tasks; }
      if (d.expenses) { expenses = d.expenses; }
      if (d.contacts) { contacts = d.contacts; }
    }

    /* ================= TASKS ================= */
    const defaultTasks = [
      { section: "1‚Äì2 Months Before Move", items: ["Create binder for moving records", "Plan moving method and get cost estimates", "Check employer moving expense benefits", "Research storage facilities", "Schedule utility dis/connection"] },
      { section: "3‚Äì4 Weeks Before Move", items: ["Finalize moving method", "Begin packing non-essential items", "Label boxes by room", "Separate valuables", "Fill out Change of Address form"] },
      { section: "1‚Äì2 Weeks Before Move", items: ["Pack suitcases with personal items", "Reconfirm moving arrangements", "Empty safe-deposit box", "Cancel services for old place"] },
      { section: "Moving Day", items: ["Pick up truck / greet movers", "Walk through house for items left behind", "Take inventory before movers leave", "Lock windows & doors"] },
      { section: "Moving In ‚Äì Weeks 1‚Äì2", items: ["Verify utilities are working", "Initial inspection & photos", "Assemble beds", "Update home inventory"] },
    ];
    let tasks = JSON.parse(JSON.stringify(defaultTasks));

    function populateSectionOptions() {
      const sel = g("new-task-section");
      sel.innerHTML = tasks.map((s, i) => `<option value="${i}">${s.section}</option>`).join("");
      sel.insertAdjacentHTML("beforeend", `<option value="new">+ New Section</option>`);
    }

    function addTask() {
      const secIndex = g("new-task-section").value;
      let sectionObj;
      if (secIndex === "new") {
        const newName = prompt("Enter name for new section:");
        if (!newName) return;
        sectionObj = { section: newName, items: [] };
        tasks.push(sectionObj);
        populateSectionOptions();
      } else {
        sectionObj = tasks[secIndex];
      }
      const txt = g("new-task-text").value.trim();
      if (!txt) return;
      sectionObj.items.push({ text: txt, done: false });
      g("new-task-text").value = "";
      renderTasks();
    }

    function editTask(i, j) {
      const itm = tasks[i].items[j];
      const current = typeof itm === "string" ? itm : itm.text;
      const newTxt = prompt("Edit task text:", current);
      if (newTxt) {
        if (typeof itm === "string") tasks[i].items[j] = newTxt; else itm.text = newTxt;
        renderTasks();
      }
    }
    function deleteTask(i, j) {
      tasks[i].items.splice(j, 1);
      renderTasks();
    }
    function toggleTask(i, j) {
      const itm = tasks[i].items[j];
      if (typeof itm === "string") {
        tasks[i].items[j] = { text: itm, done: true };
      } else {
        itm.done = !itm.done;
      }
      renderTasks();
    }
    function renderTasks() {
      const acc = g("taskAccordion");
      acc.innerHTML = "";
      let completed = 0,
        total = 0;
      tasks.forEach((sec, idx) => {
        const id = "sec" + idx;
        const checkedItems = sec.items.filter((i) => (i.done || i.done === true)).length;
        const header = `<div class="accordion-item"><h2 class="accordion-header" id="h${id}"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#c${id}">${sec.section} (${checkedItems}/${sec.items.length})</button></h2><div id="c${id}" class="accordion-collapse collapse" data-bs-parent="#taskAccordion"><div class="accordion-body"><ul class="list-group">${sec.items
          .map((item, jdx) => {
            const done = item.done ? "checked" : "";
            const label = typeof item === "string" ? item : item.text;
            total++;
            if (item.done) completed++;
            return `<li class="list-group-item d-flex justify-content-between align-items-start"><div><input class="form-check-input me-2" type="checkbox" ${done} onchange="toggleTask(${idx},${jdx})">${label}</div><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary" onclick="editTask(${idx},${jdx})">‚úé</button><button class="btn btn-outline-danger" onclick="deleteTask(${idx},${jdx})">üóë</button></div></li>`;
          })
          .join("")}</ul></div></div></div>`;
        acc.insertAdjacentHTML("beforeend", header);
      });
      updateProgress(completed, total);
    }
    function updateProgress(c, t) {
      const pct = t ? Math.round((c / t) * 100) : 0;
      const bar = g("progress-bar");
      bar.style.width = pct + "%";
      bar.textContent = pct + "%";
    }

    /* ================= EXPENSES ================= */
    let expenses = [];
    let pieChart, lineChart;
    function addExpense() {
      const name = g("expense-name").value.trim();
      const amt = parseFloat(g("expense-amount").value);
      if (!name || !amt) return;
      expenses.push({ name, amt, date: new Date().toISOString().split("T")[0] });
      g("expense-name").value = "";
      g("expense-amount").value = "";
      renderExpenses();
    }
    function deleteExpense(idx) {
      expenses.splice(idx, 1);
      renderExpenses();
    }
    function renderExpenses() {
      const list = g("expense-list");
      list.innerHTML = "";
      expenses.forEach((ex, i) => {
        list.insertAdjacentHTML(
          "beforeend",
          `<li class="list-group-item d-flex justify-content-between align-items-center">${ex.name} ‚Äì ¬£${ex.amt.toFixed(2)}<button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${i})">x</button></li>`
        );
      });
      drawPie();
      drawLine();
    }
    function drawPie() {
      const ctx = g("pieChart");
      if (pieChart) pieChart.destroy();
      if (!expenses.length) return;
      pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: expenses.map((e) => e.name),
          datasets: [{ data: expenses.map((e) => e.amt) }],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } },
      });
    }
    function drawLine() {
      const ctx = g("lineChart");
      if (lineChart) lineChart.destroy();
      if (!expenses.length) return;
      lineChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: expenses.map((e) => e.date),
          datasets: [{ label: "Expenditure", data: expenses.map((e) => e.amt) }],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });
    }

    /* ================= CONTACTS ================= */
    let contacts = [];
    function addContact() {
      const role = g("contact-role").value;
      const name = g("contact-name").value;
      const phone = g("contact-phone").value;
      const email = g("contact-email").value;
      if (!role || !name) return;
      contacts.push({ role, name, phone, email });
      ["contact-role", "contact-name", "contact-phone", "contact-email"].forEach((id) => (g(id).value = ""));
      renderContacts();
    }
    function deleteContact(idx) {
      contacts.splice(idx, 1);
      renderContacts();
    }
    function renderContacts() {
      const tbody = g("contacts-table");
      tbody.innerHTML = "";
      contacts.forEach((c, i) => {
        tbody.insertAdjacentHTML(
          "beforeend",
          `<tr><td>${c.role}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.email}</td><td><button class="btn btn-sm btn-outline-danger" onclick="deleteContact(${
